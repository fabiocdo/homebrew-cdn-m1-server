root /app/data;

location = / {
  default_type text/html;
  add_header Cache-Control "no-store" always;
  gzip off;
  try_files /_cache/index.html =404;
}

location = /health {
  default_type application/json;
  add_header Cache-Control "no-store" always;
  return 200 '{"status":"online"}';
}

location = /store.db {
  default_type application/octet-stream;
  add_header Accept-Ranges bytes always;
  add_header Cache-Control "no-store" always;
  gzip off;
  try_files $uri =404;
}

location = /update/remote.md5 {
  default_type text/plain;
  add_header Cache-Control "no-store" always;
  try_files /_cache/remote.md5 =404;
}

location = /api.php {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_request_buffering off;
  proxy_buffering off;
  proxy_pass http://127.0.0.1:8765;
}

location = /download.php {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_request_buffering off;
  proxy_buffering off;
  proxy_pass http://127.0.0.1:8765;
}

location ^~ /_internal_pkg/ {
  internal;
  alias /app/data/pkg/;
  default_type application/octet-stream;
  add_header Cache-Control "no-store" always;
  gzip off;
}

location = /update/homebrew.elf {
  default_type application/octet-stream;
  add_header Cache-Control "no-store" always;
  try_files /_cache/homebrew.elf =404;
}

location = /update/homebrew.elf.sig {
  default_type application/octet-stream;
  add_header Cache-Control "no-store" always;
  try_files /_cache/homebrew.elf.sig =404;
}

location ~* ^/pkg/.*\.pkg$ {
  try_files $uri =404;
  default_type application/octet-stream;
  add_header Accept-Ranges bytes always;
  add_header Cache-Control "public, max-age=31536000, immutable" always;
  gzip off;
}

location ~* ^/pkg/.*\.(png|jpg|jpeg|webp)$ {
  try_files $uri =404;
  add_header Cache-Control "public, max-age=2592000" always;
}

location ~* ^/pkg/.*\.(json|db)$ {
  try_files $uri =404;
  add_header Cache-Control "no-store" always;
  gzip off;
}

location ^~ /pkg/ {
  try_files $uri =404;
}

location / {
  try_files $uri $uri/ =404;
}
