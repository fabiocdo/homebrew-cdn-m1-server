# Raiz do seu conteúdo
root /app/data;

# ------------------------------------------------------------
# HOME / HEALTH
# ------------------------------------------------------------
location = / {
  default_type text/html;
  add_header Cache-Control "no-store" always;
  gzip off;
  try_files /_cache/index.html =404;
}

location = /health {
  default_type application/json;
  add_header Cache-Control "no-store" always;
  return 200 '{"status":"online"}';
}

# ------------------------------------------------------------
# STORE.DB
# ------------------------------------------------------------
location = /store.db {
  default_type application/octet-stream;
  add_header Accept-Ranges bytes always;

  # Em vez de no-store (pior), cache curto com revalidação.
  add_header Cache-Control "public, max-age=60, must-revalidate" always;

  gzip off;
  try_files $uri =404;

}

# ------------------------------------------------------------
# UPDATE FILES
# ------------------------------------------------------------
location = /update/remote.md5 {
  default_type text/plain;
  add_header Cache-Control "no-store" always;
  try_files /_cache/remote.md5 =404;
}

location = /update/homebrew.elf {
  default_type application/octet-stream;
  add_header Cache-Control "no-store" always;
  try_files /_cache/homebrew.elf =404;
}

location = /update/homebrew.elf.sig {
  default_type application/octet-stream;
  add_header Cache-Control "no-store" always;
  try_files /_cache/homebrew.elf.sig =404;
}

# ------------------------------------------------------------
# API / DOWNLOAD PROXY
# ------------------------------------------------------------
location = /api.php {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  proxy_request_buffering off;
  proxy_buffering off;

  proxy_pass http://127.0.0.1:8765;
}

location = /download.php {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  proxy_request_buffering off;
  proxy_buffering off;

  proxy_pass http://127.0.0.1:8765;
}

# ------------------------------------------------------------
# INTERNAL PKG (X-Accel-Redirect / internal)
# ------------------------------------------------------------
location ^~ /_internal_pkg/ {
  internal;
  alias /app/data/pkg/;
  default_type application/octet-stream;

  add_header Cache-Control "no-store" always;
  gzip off;

  access_log off;
  log_not_found off;
}

# ------------------------------------------------------------
# PKG FILES (grandes): pode manter otimizações aqui
# ------------------------------------------------------------
location ~* ^/pkg/.*\.pkg$ {
  try_files $uri =404;
  default_type application/octet-stream;

  add_header Accept-Ranges bytes always;
  add_header Cache-Control "public, max-age=31536000, immutable" always;

  gzip off;

  access_log off;
  log_not_found off;

  # (Opcional) se você quiser manter directio/aio pra arquivos grandes,
  # ative aqui. Se seu /app/data é bind mount “estranho”, pode comentar.
  aio threads;
  directio 8m;
  directio_alignment 512;
}

# ------------------------------------------------------------
# IMAGENS (muitas pequenas):
# ------------------------------------------------------------
location ~* ^/pkg/.*\.(png|jpg|jpeg|webp)$ {
  try_files $uri =404;

  # IMPORTANTÍSSIMO: overlay/bind + arquivos pequenos = travadas
  aio off;
  directio off;

  expires 30d;
  add_header Cache-Control "public, max-age=2592000, immutable" always;

  access_log off;
  log_not_found off;
}

# ------------------------------------------------------------
# JSON/DB
# ------------------------------------------------------------
location ~* ^/pkg/.*\.(json|db)$ {
  try_files $uri =404;
  add_header Cache-Control "no-store" always;
  gzip off;

  # Opcional: manter log, mas pode desligar se gerar volume grande
  # access_log off;
}

# ------------------------------------------------------------
# /pkg (fallback)
# ------------------------------------------------------------
location ^~ /pkg/ {
  try_files $uri =404;
}

# ------------------------------------------------------------
# Fallback
# ------------------------------------------------------------
location / {
  try_files $uri $uri/ =404;
}
